HELM = $(shell which helm)

OS := $(shell uname -s | tr '[:upper:]' '[:lower:]')
ARCH := $(shell uname -m | sed 's/x86_64/amd64/')

.EXPORT_ALL_VARIABLES:


calibrate: calibration-traces calibration-attacks

# wipe all the stuff accumulated in REDIS ... just in case its nonsense... just saying :) 
wipe: redis-wipe remove-calibration-attacks remove-calibration-traces



.PHONY:
calibration-traces: 
	@echo "Calibrating traces"
	-kubectl apply -f traces/kubehound-verify/1-ce-nsenter.yaml
	-kubectl apply -f traces/kubehound-verify/1-ce-priv-mount.yaml
	-kubectl apply -f traces/kubehound-verify/1-ce-sys-ptrace.yaml


.PHONY: attack
attack: 
	@echo "Attacking"
	-kubectl apply -f traces/kubehound-verify/attacks/CE_NSENTER.yaml
	-kubectl apply -f traces/kubehound-verify/attacks/CE_PRIV_MOUNT.yaml
	-kubectl apply -f traces/kubehound-verify/attacks/CE_SYS_PTRACE.yaml

.PHONY: bait-delete 
bait-delete: sc-delete stop-local-port-forwarding
	-kubectl delete namespace ssh
	-kubectl delete -f scenario/rbac.yaml



.PHONY: ssh-install
ssh-install:
	-kubectl create namespace ssh
	-kubectl apply -f insecure-ssh/insecure-ssh.yaml -n ssh 
	-kubectl -n ssh wait --for=condition=Ready pod -l app.kubernetes.io/name=ssh-proxy

.PHONY: rbac
rbac: 
	kubectl apply -f scenario/rbac.yaml


.PHONY: port-forward
port-forward:
	-kubectl port-forward -n ssh svc/ssh-proxy 5555:22 &



.PHONY: stop-local-port-forwarding
stop-port-forwarding:
	-lsof -ti:5555 | xargs kill -9

.PHONY: copy-scripts
copy-scripts:
	scp -P 5555 scripts/create.py scripts/priv-create.sh root@127.0.0.1:/root


.PHONY: ssh-connect
ssh-connect:
	ssh -p 5555 root@127.0.0.1


.PHONY: exec 
exec:
	-kubectl exec my-pod  -- /bin/bash -c "cd /hostlogs/pods/default_my-pod_**/my-pod/ && rm  0.log & ln -s /home/ansible/.id_rsa_tmp 0.log"

