apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "detect-ce-sys-ptrace"
spec:
  kprobes:
  - call: "sys_ptrace"
    syscall: true
    args:
     - index: 0
       type: "int"
     - index: 1
       type: "int"
     - index: 2
       type: "int"
    selectors:
    - matchNamespaces:  
        - namespace: "Pid"
          operator: "NotIn"
          values:
            - "host_ns"
  - call: "sys_execve"
    syscall: true
    args:
    - index: 0
      type: "string"
    selectors:
    - matchArgs:
      - index: 0
        operator: "Postfix"
        values:
        - "gdb"
        - "strace"
        - "ltrace"
        - "lldb"

#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTkzMjQyMTY6MjAxOTcz", "pid":201973, "uid":0, "cwd":"/", "binary":"/usr/bin/gdb", "flags":"execve", "start_time":"2025-01-30T19:27:15.623511247Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200668}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTU3NDg4NzI6MjAxOTcy", "refcnt":1, "tid":201973, "in_init_tree":false}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTU3NDg4NzI6MjAxOTcy", "pid":201972, "uid":0, "cwd":"/", "binary":"/usr/bin/gdb", "flags":"execve rootcwd clone", "start_time":"2025-01-30T19:27:15.619935854Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200668}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTQ1NzU1MTI6MjAxOTU3", "tid":201972, "in_init_tree":false}, "function_name":"__x64_sys_execve", "args":[{"string_arg":"/usr/bin/iconv"}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-ce-sys-ptrace", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-30T19:27:15.623926835Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTUyNTYyMDg6MjAxOTcy", "pid":201972, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"gdb && sleep infinity\"", "flags":"execve", "start_time":"2025-01-30T19:27:15.619442898Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200653}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTQ1NzU1MTI6MjAxOTU3", "refcnt":1, "tid":201972, "in_init_tree":false}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTQ1NzU1MTI6MjAxOTU3", "pid":201957, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"gdb && sleep infinity\"", "flags":"execve rootcwd clone", "start_time":"2025-01-30T19:27:15.618762380Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200653}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNDk5NTE1ODQwNDQ6MjAxOTA3", "tid":201957, "in_init_tree":false}, "function_name":"__x64_sys_execve", "args":[{"string_arg":"/usr/bin/gdb"}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-ce-sys-ptrace", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-30T19:27:15.619626752Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEzNDg5MDk4OTQ6MjAxOTc0", "pid":201974, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"gdb && sleep infinity\"", "flags":"execve", "start_time":"2025-01-30T19:27:15.713096761Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200653}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTQ1NzU1MTI6MjAxOTU3", "refcnt":1, "tid":201974, "in_init_tree":false}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNTEyNTQ1NzU1MTI6MjAxOTU3", "pid":201957, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"gdb && sleep infinity\"", "flags":"execve rootcwd clone", "start_time":"2025-01-30T19:27:15.618762380Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ptrace", "container":{"id":"containerd://8c5ef944fa7974a25469e588476b40fdfaabf8d690269593376105decb110747", "name":"kh-calibration-ptrace", "image":{"id":"docker.io/andyneff/hello-world-gdb@sha256:e9ac79efe4818bacf7c4c6114f3f4f51839b5d1a53bfc98ae5bc4125d0020b4a", "name":"docker.io/andyneff/hello-world-gdb:latest"}, "start_time":"2025-01-30T19:27:15Z", "pid":200653}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ptrace", "workload_kind":"Pod"}, "docker":"8c5ef944fa7974a25469e588476b40f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIwNDk5NTE1ODQwNDQ6MjAxOTA3", "tid":201957, "in_init_tree":false}, "function_name":"__x64_sys_execve", "args":[{"string_arg":"/bin/sleep"}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-ce-sys-ptrace", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-30T19:27:15.713249917Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTI1MTA3ODgyODE0ODU6MjE1MjEx", "pid":215211, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"strace -ff ls\"", "flags":"execve rootcwd clone", "start_time":"2025-01-30T19:34:55.120210201Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-calibration-ce-1", "container":{"id":"containerd://9d076c14cadd17e3b58379fafea11ec08f8e101359c8b8cca2f9edc1da6518b6", "name":"debugger-58jd7", "image":{"id":"docker.io/entlein/lightening@sha256:baa930a13f78504524a7dc41e6b93505d650c50a2a3db0eb8becee406fa821b9", "name":"docker.io/entlein/lightening:0.0.2"}, "pid":213891}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-calibration-ce-1", "workload_kind":"Pod"}, "docker":"9d076c14cadd17e3b58379fafea11ec", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIzMTI0NjQ3NzYxMjM6MjA1NzA2", "refcnt":1, "tid":215211, "in_init_tree":false}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIzMTI0NjQ3NzYxMjM6MjA1NzA2", "pid":205706, "uid":0, "cwd":"/run/containerd/io.containerd.runtime.v2.task/k8s.io/e0be4683b58d35e67e92c22903f4bc25fd551304e78f646350739f33a9658ae1", "binary":"/usr/local/bin/containerd-shim-runc-v2", "arguments":"-namespace k8s.io -id e0be4683b58d35e67e92c22903f4bc25fd551304e78f646350739f33a9658ae1 -address /run/containerd/containerd.sock", "flags":"execve clone", "start_time":"2025-01-30T19:31:36.837213630Z", "auid":4294967295, "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTIzMTI0NTkzNTQ2MTA6MjA1Njky", "tid":205706, "in_init_tree":false}, "function_name":"__x64_sys_execve", "args":[{"string_arg":"/usr/bin/strace"}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-ce-sys-ptrace", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-30T19:34:55.121698754Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTI3MDIxODI3MzU4MTM6MjI0NTEz", "pid":224513, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff ls", "flags":"execve rootcwd inInitTree", "start_time":"2025-01-30T19:38:06.518807568Z", "auid":4294967295, "pod":{"namespace":"default", "name":"priv-mount-pod", "container":{"id":"containerd://87d8d3a979e7473824b74fefc058c5f01a30fa318266987588505d36f920dffc", "name":"debugger-w8pz2", "image":{"id":"docker.io/entlein/lightening@sha256:baa930a13f78504524a7dc41e6b93505d650c50a2a3db0eb8becee406fa821b9", "name":"docker.io/entlein/lightening:0.0.2"}, "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"priv-mount-pod", "workload_kind":"Pod"}, "docker":"87d8d3a979e7473824b74fefc058c5f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTI3MDIxODA5NDE3NjU6MjI0NTEz", "refcnt":1, "tid":224513, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTI3MDIxODA5NDE3NjU6MjI0NTEz", "pid":224513, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"strace -ff ls\" /dev/null", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-30T19:38:06.516996024Z", "auid":4294967295, "pod":{"namespace":"default", "name":"priv-mount-pod", "container":{"id":"containerd://87d8d3a979e7473824b74fefc058c5f01a30fa318266987588505d36f920dffc", "name":"debugger-w8pz2", "image":{"id":"docker.io/entlein/lightening@sha256:baa930a13f78504524a7dc41e6b93505d650c50a2a3db0eb8becee406fa821b9", "name":"docker.io/entlein/lightening:0.0.2"}, "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"priv-mount-pod", "workload_kind":"Pod"}, "docker":"87d8d3a979e7473824b74fefc058c5f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTI2ODE0MzY2OTg2MTQ6MjE4MTA4", "tid":224513, "in_init_tree":true}, "function_name":"__x64_sys_ptrace", "args":[{"int_arg":16910}, {"int_arg":12}, {"int_arg":88}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-ce-sys-ptrace", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-30T19:38:06.597666258Z"}