#https://saimanasak.medium.com/kubernetes-pod-creation-process-2fe484ca901d

apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "detect-pod-create-using-kubectl"
spec:
  kprobes:
  - call: "sys_openat"
    syscall: true
    args:
      - index: 0
        type: "int"
      - index: 1
        type: "string"
      - index: 2
        type: "int"
    selectors:
    - matchArgs:      
      - index: 1
        operator: "Prefix"
        values: 
         - "/root/.kube/cache" #this one is NOISY
         - "/root/.kube/config"
  - call: "sys_read"  
    syscall: true
    return: true
    args:
      - index: 0 #fd
        type: "int"
      - index: 1 #buf
        type: "char_buf"
        returnCopy: true
      - index: 2 #count
        type: "size_t"
    returnArg:
      index: 2
      type: "size_t"
    selectors:
      - matchPIDs:
        - operator: NotIn
          followForks: true
          values:
          - 0
          - 1
        matchArgs:
        - index: 0
          operator: "Equal"
          values: ["0"] 
        # - index: 1
        #   operator: "In"  
        #   values:
        #   - "apiVersion: v1" 
        # matchNamespaces: 
        # - namespace: "Pid"
        #   operator: "NotIn"
        #   values:
        #   - "host_ns"
        matchBinaries:
        - operator: "NotIn"
          values:
          - "/usr/bin/jq" #this is the containerruntime


#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTEwOTMwMTA1MDA5NzAyOjgwNDI5MQ==", "pid":804291, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:37:00.074188099Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://2bd0dad2a647daf9a986a57cdf4f5901b5eb5ced3c721c719dbb312f99613dbf", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:37:00Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"2bd0dad2a647daf9a986a57cdf4f590", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTEwOTMwMDk4NzgyOTIyOjgwNDI4OA==", "refcnt":1, "tid":804293, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTEwOTMwMDk4NzgyOTIyOjgwNDI4OA==", "pid":804288, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:37:00.067960858Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://2bd0dad2a647daf9a986a57cdf4f5901b5eb5ced3c721c719dbb312f99613dbf", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:37:00Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"2bd0dad2a647daf9a986a57cdf4f590", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTEwOTMwMDk3MzM3ODY1OjgwNDI3Mg==", "tid":804288, "in_init_tree":true}, "function_name":"__x64_sys_read", "args":[{"int_arg":0}, {"bytes_arg":"YXBpVmVyc2lvbjogdjEKa2luZDogUG9kCm1ldGFkYXRhOgogIG5hbWU6IGt1YmVob3VuZC1wb2QtY3JlYXRlLXBvZAogIG5hbWVzcGFjZTogZGVmYXVsdApzcGVjOgogIG5vZGVOYW1lOiBob25leWNsdXN0ZXItY29udHJvbC1wbGFuZSAKICBjb250YWluZXJzOgogIC0gbmFtZTogcHJpdmlsZWdlZC1jb250YWluZXIKICAgIGltYWdlOiBlbnRsZWluL2lkZW50aXR5LWltcGVyc29uYXRlOjAuMC4xCiAgICBzZWN1cml0eUNvbnRleHQ6CiAgICAgIGNhcGFiaWxpdGllczoKICAgICAgICBhZGQ6IFsiU1lTX0FETUlOIiwgIk5FVF9BRE1JTiIsICJTWVNfUFRSQUNFIiwgIlNZU19NT0RVTEUiLCAiREFDX09WRVJSSURFIiwgIlNFVFVJRCIsICJTRVRHSUQiXSAKICAgIHZvbHVtZU1vdW50czoKICAgIC0gbW91bnRQYXRoOiAvaG9zdAogICAgICBuYW1lOiBob3N0LXJvb3QgCiAgdm9sdW1lczoKICAgIC0gbmFtZTogaG9zdC1yb290CiAgICAgIGhvc3RQYXRoOgogICAgICAgIHBhdGg6IC8K"}, {"size_arg":"4096"}], "return":{"size_arg":"501"}, "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:37:00.263329141Z"}

#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzcwNDU4NjQwOjc4ODA3Ng==", "pid":788076, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:18:50.792924920Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:18:50Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"dddcb7ac3cf4649fe5b55a90ab834aa", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzY0MzMxMDM2Ojc4ODA3Mw==", "refcnt":1, "tid":788080, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzY0MzMxMDM2Ojc4ODA3Mw==", "pid":788073, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:18:50.786797271Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:18:50Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"dddcb7ac3cf4649fe5b55a90ab834aa", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzYyODkyMzkyOjc4ODA1Ng==", "tid":788073, "in_init_tree":true}, "function_name":"__x64_sys_read", "args":[{"int_arg":0}, {"bytes_arg":""}, {"int_arg":4096}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:18:50.980624095Z"}

#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzA1NTE1MjMxOjc4ODA2NQ==", "pid":788065, "uid":0, "cwd":"/run/containerd/io.containerd.runtime.v2.task/k8s.io/dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0/rootfs", "binary":"/usr/bin/jq", "arguments":"-r .bundle", "flags":"execve clone inInitTree", "start_time":"2025-01-17T16:18:50.727982036Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:18:50Z", "pid":8}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"dddcb7ac3cf4649fe5b55a90ab834aa", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzAyNzMwODkyOjc4ODA2NA==", "refcnt":1, "tid":788065, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNzAyNzMwODkyOjc4ODA2NA==", "pid":788064, "uid":0, "cwd":"/run/containerd/io.containerd.runtime.v2.task/k8s.io/dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0/rootfs", "binary":"/kind/bin/mount-product-files.sh", "arguments":"/kind/bin/mount-product-files.sh", "flags":"execve clone inInitTree", "start_time":"2025-01-17T16:18:50.725197185Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://dddcb7ac3cf4649fe5b55a90ab834aa7ae977d38bbd0e2521b79b7ed000b81e0", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:18:50Z", "pid":7}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"dddcb7ac3cf4649fe5b55a90ab834aa", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5ODQwNjg4NTkwNTIyOjc4ODA1Ng==", "tid":788064, "in_init_tree":true}, "function_name":"__x64_sys_read", "args":[{"int_arg":0}, {"bytes_arg":""}, {"int_arg":4096}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:18:50.768467917Z"}





# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDYxMTM3MjgyOjc4MDY1NA==", "pid":780654, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.070202323Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "refcnt":1, "tid":780657, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "pid":780651, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.063351324Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDUyMjMzNjgwOjc4MDYzNQ==", "tid":780651, "in_init_tree":true}, "function_name":"__x64_sys_openat", "args":[{"int_arg":-100}, {"string_arg":"/root/.kube/cache/http/.diskv-temp/1467711680"}, {"int_arg":524482}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:39.366000749Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDYxMTM3MjgyOjc4MDY1NA==", "pid":780654, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.070202323Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "refcnt":1, "tid":780657, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "pid":780651, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.063351324Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDUyMjMzNjgwOjc4MDYzNQ==", "tid":780651, "in_init_tree":true}, "function_name":"__x64_sys_openat", "args":[{"int_arg":-100}, {"string_arg":"/root/.kube/cache/discovery/10.96.0.1_443/servergroups.json"}, {"int_arg":524288}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:39.487626050Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDYxMTM3MjgyOjc4MDY1NA==", "pid":780654, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.070202323Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "refcnt":1, "tid":780660, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "pid":780651, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.063351324Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDUyMjMzNjgwOjc4MDYzNQ==", "tid":780651, "in_init_tree":true}, "function_name":"security_file_permission", "args":[{"file_arg":{"path":"/run/secrets/kubernetes.io/serviceaccount/..2025_01_17_16_10_37.200435080/token", "permission":"-rw-r--r--"}}, {"int_arg":4}], "return":{"int_arg":0}, "action":"KPROBE_ACTION_POST", "policy_name":"enumerate-service-account", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:39.772749983Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDYxMTM3MjgyOjc4MDY1NA==", "pid":780654, "uid":0, "cwd":"/", "binary":"/usr/local/bin/kubectl", "arguments":"create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.070202323Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":13}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "refcnt":1, "tid":780659, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDU0Mjg1OTQ4Ojc4MDY1MQ==", "pid":780651, "uid":0, "cwd":"/", "binary":"/usr/bin/strace", "arguments":"-ff -o /tmp/strace.out kubectl create -f -", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:39.063351324Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create", "container":{"id":"containerd://6b4bcc4472978987dd678b719a7dda32c87d6a27a5eceac5b38abc309de7801f", "name":"attacker-container", "image":{"id":"docker.io/entlein/pod-create@sha256:f0edefca212e3cde551cc4662c02a4753d5cc4703deba256725afaadfd5d10a6", "name":"docker.io/entlein/pod-create:0.0.1"}, "start_time":"2025-01-17T16:10:39Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kubehound-pod-create", "workload_kind":"Pod"}, "docker":"6b4bcc4472978987dd678b719a7dda3", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzQ5MDUyMjMzNjgwOjc4MDYzNQ==", "tid":780651, "in_init_tree":true}, "function_name":"__x64_sys_openat", "args":[{"int_arg":-100}, {"string_arg":"/root/.kube/cache/http/.diskv-temp/4278315781"}, {"int_arg":524482}], "action":"KPROBE_ACTION_POST", "policy_name":"detect-pod-create-using-kubectl", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:39.497071600Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg2NzkwMDg0Ojc4MDgyNg==", "pid":780826, "uid":0, "cwd":"/", "binary":"/usr/bin/cat", "arguments":"/var/run/secrets/kubernetes.io/serviceaccount/token", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:40.395855500Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":10}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "tid":780826, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "pid":780811, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:40.393208596Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":1}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMTM5NDE5NjkwOjc4MDc1Ng==", "tid":780811, "in_init_tree":true}, "function_name":"security_file_permission", "args":[{"file_arg":{"path":"/run/secrets/kubernetes.io/serviceaccount/..2025_01_17_16_10_39.3084930107/token", "permission":"-rw-r--r--"}}, {"int_arg":4}], "return":{"int_arg":0}, "action":"KPROBE_ACTION_POST", "policy_name":"enumerate-service-account", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:40.397298450Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg2NzkwMDg0Ojc4MDgyNg==", "pid":780826, "uid":0, "cwd":"/", "binary":"/usr/bin/cat", "arguments":"/var/run/secrets/kubernetes.io/serviceaccount/token", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:40.395855500Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":10}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "tid":780826, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "pid":780811, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:40.393208596Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":1}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMTM5NDE5NjkwOjc4MDc1Ng==", "tid":780811, "in_init_tree":true}, "function_name":"security_file_permission", "args":[{"file_arg":{"path":"/run/secrets/kubernetes.io/serviceaccount/..2025_01_17_16_10_39.3084930107/token", "permission":"-rw-r--r--"}}, {"int_arg":4}], "return":{"int_arg":0}, "action":"KPROBE_ACTION_POST", "policy_name":"enumerate-service-account", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:40.396880750Z"}
# {"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg5Njc0OTczOjc4MDgyNw==", "pid":780827, "uid":0, "cwd":"/", "binary":"/usr/bin/curl", "arguments":"-sSk -H \"Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6ImkwVWVHcVN5bHlTUTktaTlIZ1lPcDB4UEdqaFB2ODE2NTJ6YTJ5LXZCWEEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY4NjY2MjM5LCJpYXQiOjE3MzcxMzAyMzksImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiMTc5YzIxNTUtYTVjZS00NDQ0LWFkYjAtNTY5MTQ3YzUzYzQzIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoiaG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmUiLCJ1aWQiOiJiNjE1NzJhYi03NTI4LTRkMmEtYjIzZC01NTUwY2FkZDNhNDIifSwicG9kIjp7Im5hbWUiOiJrdWJlaG91bmQtcG9kLWNyZWF0ZS1wb2QiLCJ1aWQiOiJmNDkzNTMxOC05ZTlkLTQ4ZTEtODg2OS01ZTc4OGY4NmZjYTIifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6ImRlZmF1bHQiLCJ1aWQiOiI1Y2VjYWEwZC01NThmLTQwYmQtYjdhOS1lNzY2NjlhMWExY2EifSwid2FybmFmdGVyIjoxNzM3MTMzODQ2fSwibmJmIjoxNzM3MTMwMjM5LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpkZWZhdWx0In0.MmK8GCzt8cjugOa0O2hxQijH8DqJCmyTec5W1G6GqOw06ArVRVU3n39AzD6fASEsGRCowA5MLdatr-k01ec9gOFQmzQ4HxDUXERDNng2iXQADi6oC9JcP022OVIjDhkDnToguPSQyNt7E7y3EAbFScgw5D7av1CXs1j7B3wYxM2qwOWEFAmh7rdlwjkWvpfi1O30FUX1HJGU2PtV3iHITJNOiuXgCIjxxw3REgsHDSSpmHRQ1ueZo3oAQ4MpFMObuu-i2pJYB_e_EHqIoiUv8Ms-LDHsyoYwBTLbdmAwM3DVzkfMsY3YhkA0w3h_lqUhkvMsu5V2NVdj7z7VL8PEMQ\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://10.96.0.1:443/api/v1/pods", "flags":"execve rootcwd clone dataArgs inInitTree", "start_time":"2025-01-17T16:10:40.398739649Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":11}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "tid":780827, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMzg0MTQyMzkyOjc4MDgxMQ==", "pid":780811, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-17T16:10:40.393208596Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kubehound-pod-create-pod", "container":{"id":"containerd://e65e1e8641331bacd93c8499b2fe9d917e61c4a72d283652cddd6174b0abcf46", "name":"privileged-container", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-17T16:10:40Z", "pid":1}, "workload":"kubehound-pod-create-pod", "workload_kind":"Pod"}, "docker":"e65e1e8641331bacd93c8499b2fe9d9", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTA5MzUwMTM5NDE5NjkwOjc4MDc1Ng==", "tid":780811, "in_init_tree":true}, "function_name":"tcp_connect", "args":[{"sock_arg":{"family":"AF_INET", "type":"SOCK_STREAM", "protocol":"IPPROTO_TCP", "saddr":"10.244.0.60", "daddr":"10.96.0.1", "sport":48998, "dport":443, "cookie":"18446638092876599552", "state":"TCP_SYN_SENT"}}], "action":"KPROBE_ACTION_POST", "policy_name":"monitor-network-activity-outside-cluster-cidr-range", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-17T16:10:40.405960014Z"}

